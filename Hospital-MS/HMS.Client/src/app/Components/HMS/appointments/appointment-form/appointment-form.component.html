<main id="add-reservation" @fadeIn>
    <div class="container-fluid">
        <div class="card search-patient p-2 col-6 m-auto text-center">
            <h5 class="text-center">ุจุญุซ ุนู ูุฑูุถ ููุฌูุฏ</h5>
            <div class="col-6 m-auto mt-2">
                <div class="input-group">
                    <input type="search" class="form-control shadow-none" placeholder="ุงุจุญุซ ุจุฑูู ุงููุงุชู ูุชุนุจุฆุฉ ุงูุจูุงูุงุช ุชููุงุฆููุง .." (input)="searchPatientByPhone($event)" maxlength="11" />
                    <span class="input-group-text">
            <svg width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
              <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.415l-3.85-3.85a1.007 1.007 0 0 0-.115-.098zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
            </svg>
          </span>
                </div>
            </div>
        </div>
        <form [formGroup]="reservationForm" class="form p-2" (ngSubmit)="onSubmit()">
            <p-toast position="top-left"></p-toast>
            <h4>๐คุจูุงูุงุช ุงููุฑูุถ</h4>
            <div class="row mb-3">
                <div class="col-lg-4">
                    <label for="patientName" class="form-label">ุฅุณู ุงููุฑูุถ</label>
                    <input type="text" id="patientName" class="form-control shadow-none" placeholder="ุฃุฏุฎู ุฅุณู ุงููุฑูุถ" formControlName="patientName">
                    <div *ngIf="reservationForm.get('patientName')?.invalid && reservationForm.get('patientName')?.touched" class="text-danger">
                        ุงุณู ุงููุฑูุถ ูุทููุจ
                    </div>
                </div>

                <div class="col-lg-4">
                    <label for="patientPhone" class="form-label">ุฑูู ุงููุงุชู </label>
                    <input type="text" id="patientPhone" class="form-control shadow-none" placeholder="ุฃุฏุฎู ุฑูู ุงููุงุชู " formControlName="patientPhone">
                    <div *ngIf="reservationForm.get('patientPhone')?.invalid && reservationForm.get('patientPhone')?.touched" class="text-danger">
                        <ng-container *ngIf="reservationForm.get('patientPhone')?.errors?.['required']">ุฑูู ุงููุงุชู ูุทููุจ</ng-container>
                        <ng-container *ngIf="reservationForm.get('patientPhone')?.errors?.['pattern']">ุฑูู ุงููุงุชู ุบูุฑ ุตุญูุญ</ng-container>
                    </div>
                </div>
                <div class="col-lg-4">
                    <label for="gender" class="form-label">ุงูููุน</label>
                    <select id="gender" class="form-select shadow-none" formControlName="gender">
            <option selected disabled value="">ุงุฎุชุฑ ุงูููุน</option>
            <option value="Male">ุฐูุฑ</option>
            <option value="Female">ุงูุซู</option>
          </select>
                    <div *ngIf="reservationForm.get('gender')?.invalid && reservationForm.get('gender')?.touched" class="text-danger">
                        ุงูููุน ูุทููุจ
                    </div>
                </div>


            </div>
            <hr>

            <h4>๐ฅุจูุงูุงุช ุงูุญุฌุฒ</h4>
            <div class="row mb-3">
                <div class="col-md-8 mb-2">
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-success d-flex align-items-center gap-2 border rounded px-3" (click)="openAppointmentDetailsModal(null)">
                            <i class="fas fa-plus-circle"></i>
                            <span>ุฅุถุงูุฉ</span>
                        </button>
                    </div>
                </div>
                <div class="p-3 bg-white">
                    <div class="table-responsive shadow-sm radius-10">
                        <table class="table table-card-table table-borderless table-hover bg-transparent m-0">
                            <thead>
                                <tr>
                                    <th>ุชุงุฑูุฎ ุงูุญุฌุฒ</th>
                                    <th>ููุน ุงูุญุฌุฒ</th>
                                    <th>ููุน ุงูุฎุฏูุฉ</th>
                                    <th>ุงูุฏูุชูุฑ ุงููุฎุชุต</th>
                                    <th>ุงูุชูููุฉ</th>
                                    <th>ุงูุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody>
                                <ng-container>
                                    <tr *ngFor="let item of appointmentDetailsSelected; let i = index">
                                        <td>{{ item.appointmentDate | date: 'dd/MM/yyyy' }}</td>
                                        <td>{{ item.appointmentType | medicalTypeToArabic }}</td>
                                        <td>{{ item.medicalServiceName }}</td>
                                        <td>{{ item.doctorName ?? '---' }}</td>
                                        <td>{{ item.price }} ุฌููู</td>
                                        <td class="d-flex gap-2">
                                            <!-- <button type="button" class="btn btn-primary" (click)="openAppointmentDetailsModal(item)">
                                                <i class="fas fa-edit"></i>
                                            </button> -->
                                            <button type="button" class="btn btn-danger" (click)="deleteAppointment(i)">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr *ngIf="appointmentDetailsSelected?.length">
                                        <td></td>
                                        <td colspan="2" class="text-end fw-bold">ุฅุฌูุงูู ุชูููุฉ ุงูุฎุฏูุฉ</td>
                                        <td></td>
                                        <td class="fw-bold">{{ totalPrice }} ุฌููู</td>
                                        <td></td>
                                    </tr>
                                </ng-container>
                                <ng-container>
                                    <tr *ngIf="!appointmentDetailsSelected?.length">
                                        <td colspan="12" class="text-right">
                                            <app-empty-data [showEmptyData]="!appointmentDetailsSelected?.length"></app-empty-data>
                                        </td>
                                    </tr>
                                </ng-container>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <hr>
            <div class="card-header border-bottom bg-gray d-flex align-items-center justify-content-between hh-50 px-3">
                <h5 class="mb-0 fw-bold">
                    <span>๐ุจูุงูุงุช ุฅุถุงููุฉ</span>
                </h5>
                <button type="button" class="btn-blue" (click)="showAdditionalInfo = !showAdditionalInfo">
                {{ showAdditionalInfo ? 'ุฅุฎูุงุก' : 'ุฅุธูุงุฑ' }}
            </button>
            </div>
            <div class="row mb-3" *ngIf="showAdditionalInfo">
                <div class="col-lg-4">
                    <label for="insuranceCompanyId" class="form-label">ุดุฑูุฉ ุงูุชุฃููู</label>
                    <select id="insuranceCompanyId" class="form-select shadow-none" formControlName="insuranceCompanyId">
            <option selected disabled value="">ุงุฎุชุฑ ุดุฑูุฉ ุงูุชุฃููู</option>
            <option *ngFor="let insuranceCompany of insuranceCompanies" [value]="insuranceCompany.id">{{ insuranceCompany.name }}</option>
          </select>
                </div>
                <div class="col-lg-4">
                    <label for="insuranceCategoryId" class="form-label">ูุฆุฉ ุงูุชุฃููู</label>
                    <select id="insuranceCategoryId" class="form-select shadow-none" formControlName="insuranceCategoryId">
                    <option selected disabled value="">ุงุฎุชุฑ ูุฆุฉ ุงูุชุฃููู</option>
                    <option *ngFor="let insuranceCategory of insuranceCategories" [value]="insuranceCategory.id">{{insuranceCategory.name}}</option>
                  </select>
                    <div *ngIf="reservationForm.get('insuranceCategoryId')?.invalid && reservationForm.get('insuranceCategoryId')?.touched" class="text-danger">
                        ูุฆุฉ ุงูุชุฃููู ูุทููุจุฉ
                    </div>
                </div>
                <div class="col-lg-4">
                    <label for="insuranceNumber" class="form-label">ุฑูู ุงูุชุฃููู</label>
                    <input type="text" id="insuranceNumber" class="form-control shadow-none" formControlName="insuranceNumber" placeholder="ุฃุฏุฎู ุฑูู ุงูุชุฃููู" pattern="[0-9]*">
                </div>

                <div class="col-lg-4 mt-3">
                    <label class="form-label">ุชู ุชุญููููุ</label>
                    <div class="form-check">
                        <input type="radio" id="referredYes" class="form-check-input shadow-none" formControlName="referred" value="yes">
                        <label for="referredYes" class="form-check-label">ูุนู</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" id="referredNo" class="form-check-input shadow-none" formControlName="referred" value="no">
                        <label for="referredNo" class="form-check-label">ูุง</label>
                    </div>
                </div>
                <div class="col-lg-4 mt-3" *ngIf="reservationForm.get('referred')?.value === 'yes'">
                    <label for="referredClinic" class="form-label">ุงูุนูุงุฏุฉ ุงููุญูู ูููุง</label>
                    <select [disabled]="!reservationForm.get('referred')?.value" id="referredClinic" class="form-select shadow-none" formControlName="referredClinic">
            <option selected disabled value="">ุงุฎุชุฑ ุงูุนูุงุฏุฉ</option>
            <option value="ุนูุงุฏุฉ ุงูุนุธุงู">ุนูุงุฏุฉ ุงูุนุธุงู</option>
            <option value="ุนูุงุฏุฉ ุงูุจุงุทูุฉ">ุนูุงุฏุฉ ุงูุจุงุทูุฉ</option>
          </select>
                </div>
                <!-- <div class="col-lg-4 mt-3">
          <label class="form-label">ุญุงุตู ุนูู ุชุทุนููุ</label>
          <div class="form-check">
            <input type="radio" id="vaccinatedYes" class="form-check-input shadow-none" formControlName="vaccinated" value="yes">
            <label for="vaccinatedYes" class="form-check-label">ูุนู</label>
          </div>
          <div class="form-check">
            <input type="radio" id="vaccinatedNo" class="form-check-input shadow-none" formControlName="vaccinated" value="no">
            <label for="vaccinatedNo" class="form-check-label">ูุง</label>
          </div>
        </div> -->
                <div class="col-lg-4 mt-3">
                    <label for="paymentMethod" class="form-label">ูุณููุฉ ุงูุฏูุน</label>
                    <select id="paymentMethod" class="form-select shadow-none" formControlName="paymentMethod">
                    <option selected disabled value="">ุงุฎุชุฑ ูุณููุฉ ุงูุฏูุน</option>
                    <option value="ููุฏู">ููุฏู</option>
                    <option value="ุชุญููู ูุญุธู">ุชุญููู ูุญุธู</option>
          </select>
                </div>
            </div>
            <div class="row justify-content-center gap-2 px-3">
                <button type="submit" [disabled]="!reservationForm.valid" class="btn-blue col-2">ุฅุถุงูุฉ</button>
                <button type="reset" class="btn-outline-blue col-2">ุงูุบุงุก</button>
            </div>
        </form>
    </div>
</main>

<app-print-invoice #PrintInvioce style="display: none;"></app-print-invoice>

<div class="modal fade" id="AppointmentDetailsModal" tabindex="-1" aria-labelledby="AppointmentDetailsLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <!-- <img src="assets/vendors/imgs/pattern.png" alt="" class="img-fluid"> -->
            <div class="modal-header justify-content-center">
                <h5 class="modal-title" id="AppointmentDetailsLabel">ุฅุถุงูุฉ ุจูุงูุงุช</h5>
            </div>
            <div class="modal-body p-4">
                <form [formGroup]="appointmentDetailsForm" (ngSubmit)="AddAppointmentDetails()">
                    <div class="mb-3">
                        <label for="app-date" class="form-label">ุชุงุฑูุฎ ุงูุญุฌุฒ</label>
                        <input id="app-date" type="date" formControlName="appointmentDate" class="form-control shadow-none" (change)="onDayChange()">

                        <div *ngIf="appointmentDetailsForm.get('appointmentDate')?.invalid && appointmentDetailsForm.get('appointmentDate')?.touched && appointmentDetailsForm.get('appointmentDate')?.errors?.['notToday']" class="text-danger">
                            ุชุงุฑูุฎ ุงูุญุฌุฒ ูุฌุจ ุฃู ูููู ุงูููู ุฃู ูุงุญููุง
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="clinic-type" class="form-label">ููุน ุงูุญุฌุฒ</label>
                        <select id="clinic-type" class="form-select shadow-none" formControlName="appointmentType" (change)="onAppointmentTypeChange()">
                            <option selected disabled [value]="null">ุงุฎุชุฑ ููุน ุงูุญุฌุฒ</option>
                            <option value="General">ูุดู</option>
                            <option value="Consultation">ุงุณุชุดุงุฑุฉ</option>
                            <option value="Surgery">ุนูููุงุช</option>
                            <option value="Screening">ุชุญุงููู</option>
                            <option value="MRI">ุฃุดุนุฉ ุฑููู</option>
                            <option value="Panorama">ุฃุดุนุฉ ุจุงููุฑุงูุง</option>
                            <option value="XRay">ุฃุดุนุฉ ุนุงุฏูุฉ</option>
                            <option value="CTScan">ุฃุดุนุฉ ููุทุนูุฉ</option>
                            <option value="Ultrasound">ุฃุดุนุฉ ุณููุงุฑ</option>
                            <option value="Echo">ุฃุดุนุฉ ุฅููู</option>
                            <option value="Mammogram">ุฃุดุนุฉ ูุงููุฌุฑุงู</option>                        </select>
                        <div *ngIf="appointmentDetailsForm.get('appointmentType')?.invalid && appointmentDetailsForm.get('appointmentType')?.touched" class="text-danger">
                            ููุน ุงูุญุฌุฒ ูุทููุจ
                        </div>
                    </div>

                    <div class="mb-3" *ngIf="IsGeneral">
                        <label for="clinic" class="form-label">
                            ุงูุฎุฏูุฉ ุงูุทุจูุฉ
                        </label>
                        <select id="clinic" class="form-select shadow-none" formControlName="medicalServiceId" (change)="onServiceSelected()">
                            <option selected disabled [value]="null">ุงุฎุชุฑ ุงูุฎุฏูุฉ</option>
                            <option *ngFor="let service of filteredServices" [ngValue]="service.id">
                                {{ service.name }}
                            </option>                              
                            <option *ngIf="filteredServices.length === 0" disabled>
                                {{ selectedDate ? 'ูุง ุชูุฌุฏ ุฎุฏูุงุช ูุชุงุญุฉ ูู ุงูููู ุงููุญุฏุฏ' : 'ูุง ุชูุฌุฏ ุฎุฏูุงุช ูุชุงุญุฉ ููููุน ุงููุญุฏุฏ' }}
                            </option>
                        </select>
                        <div *ngIf="appointmentDetailsForm.get('medicalServiceId')?.invalid && appointmentDetailsForm.get('medicalServiceId')?.touched" class="text-danger">
                            ุงูุฎุฏูุฉ ุงูุทุจูุฉ ูุทููุจุฉ
                        </div>
                    </div>

                    <div class="mb-3" *ngIf="appointmentDetailsForm.get('appointmentType')?.value && IsGeneral">
                        <label for="clinic-doctor" class="form-label">ุงูุฏูุชูุฑ ุงููุฎุชุต</label>
                        <select id="clinic-doctor" class="form-select shadow-none" formControlName="doctorId" (change)="onDoctorSelected()">
                            <option selected disabled [value]="null">ุงุฎุชุฑ ุงูุฏูุชูุฑ ุงููุฎุชุต</option>
                            <option *ngFor="let doctor of filteredDoctors" [value]="doctor.id">
                            {{ doctor.fullName }}
                            </option>
                            <option *ngIf="filteredDoctors.length === 0" disabled>
                            {{ selectedDate ? 'ูุง ููุฌุฏ ุฃุทุจุงุก ูุชุงุญูู ูู ุงูููู ุงููุญุฏุฏ' : 'ูุง ููุฌุฏ ุฃุทุจุงุก ูุชุงุญูู ููุฐู ุงูุฎุฏูุฉ' }}
                            </option>
                        </select>
                        <div *ngIf="appointmentDetailsForm.get('doctorId')?.invalid && appointmentDetailsForm.get('doctorId')?.touched" class="text-danger">
                            ุงูุฏูุชูุฑ ุงููุฎุชุต ูุทููุจ
                        </div>
                    </div>

                    <div class="mb-3" *ngIf="IsScreening || IsRadiology">
                        <label for="clinic" class="form-label">
                            {{IsScreening ? 'ููุน ุงูุชุญููู': 'ููุน ุงูุฃุดุนุฉ'}}
                        </label>
                        <select id="clinic" class="form-select shadow-none" formControlName="medicalServiceId" (change)="onServiceSelected()">
                        <option selected disabled [value]="null">ุงุฎุชุฑ ุงูุฎุฏูุฉ</option>
                        <option *ngFor="let service of filteredServices" [value]="service.id">
                        {{ service.name }}
                        </option>
                        <option *ngIf="filteredServices.length === 0" disabled>
                        {{ selectedDate ? 'ูุง ุชูุฌุฏ ุฎุฏูุงุช ูุชุงุญุฉ ูู ุงูููู ุงููุญุฏุฏ' : 'ูุง ุชูุฌุฏ ุฎุฏูุงุช ูุชุงุญุฉ ููููุน ุงููุญุฏุฏ' }}
                        </option>
                    </select>
                        <div class="min-width-200 max-width-500 small-scroll overflow-auto p-2">
                            <span class="badge round min-width-60 badge-muted me-1 mb-1" *ngFor="let item of radiologyTypesSelected;let i = index">
                            {{ item.name }}
                            <i class="fas fa-times ms-1 cursor-pointer"
                          (click)="removeRadiologyType(i)"
                          title="ุญุฐู"
                          style="font-size: 0.8rem;"></i>
                          </span>
                        </div>
                        <div *ngIf="appointmentDetailsForm.get('medicalServiceId')?.invalid && appointmentDetailsForm.get('medicalServiceId')?.touched" class="text-danger">
                            {{ IsScreening ? 'ููุน ุงูุชุญููู ูุทููุจ' : 'ููุน ุงูุฃุดุนุฉ ูุทููุจุฉ' }}
                        </div>
                    </div>


                    <div class="d-flex justify-content-center">
                        <button type="submit" class="btn-blue" [disabled]="appointmentDetailsForm.invalid">ุญูุธ ุงูุชุบููุฑุงุช</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>