<main id="list-patients" @fadeIn>
    <p-toast position="top-left"></p-toast>
    <div class="container-fluid">
        <app-breadcrumb [TitleList]="TitleList"></app-breadcrumb>
        <div class="row mt-4 mb-3">
            <div class="col-lg-2" *ngFor="let status of patientServices">
                <div class="card text-white p-3 text-center" (click)="ApplyCardFilter(status)" [ngStyle]="{ 'background-image': status.color }">
                    <h4>{{ status.name }}</h4>
                    <p class="mt-0">{{ status.count }} ูุฑูุถ</p>
                    <div class="percentage d-flex align-items-center justify-content-center gap-1">
                        <p class="m-0">12%</p>
                        <i class="fa-regular fa-circle-arrow-up"></i>
                    </div>
                    <img [src]="status.img" alt="" class="vector" />
                </div>
            </div>
        </div>

        <div class="table-card border radius-10 overflow-hidden shadow-sm">
            <div class="align-items-center border-bottom d-flex flex-wrap justify-content-between p-3 table-card-title bg-light">
                <div class="col-md-8 mb-2">
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-success d-flex align-items-center gap-2 border rounded px-3" routerLink="/hms/appointments/add">
                    <i class="fas fa-plus-circle"></i>
                    <span>ุฅุถุงูุฉ ุญุฌุฒ</span>
                </button>
                        <button class="btn btn-success d-flex align-items-center gap-2 border rounded px-3">
                    <i class="fas fa-close"></i>
                    <span>ุฅุบูุงู ุญุฑูุฉ ุงูุดููุช</span>
                </button>
                        <button class="btn btn-success d-flex align-items-center gap-2 border rounded px-3" (click)="isFilter = !isFilter" [attr.aria-expanded]="!isFilter">
                    <i class="uil uil-filter"></i>
                    <span class="navbar-brand m-0">{{ isFilter ? 'ุนุฑุถ' : 'ุงุฎูุงุก' }} ุงูููุงุชุฑ</span>
                </button>
                    </div>
                </div>
                <div class="col-md-4 mb-2" *ngIf="total > 0">
                    <app-pagination (pageChanged)="onPageChange($event)" [currentPage]="pagingFilterModel.currentPage" [pageSize]="pagingFilterModel.pageSize" [totalCount]="total"></app-pagination>
                </div>
                <div class="col-md-12 mt-3" #collapse="ngbCollapse" [(ngbCollapse)]="isFilter">
                    <div class="d-flex align-items-center">
                        <ng-container>
                            <app-filters [filterData]="AppointmentTypes" [filterPlaceholder]="'ุงูููุน'" [searchPlaceholder]="'ุฃุฏุฎู ุฅุณู ุงููุฑูุถ ุฃู ุฑูู ุงููุงุชู ...'" [categoryName]="'Type'" (filterChanged)="filterChecked($event)"></app-filters>
                        </ng-container>
                    </div>
                </div>
            </div>
            <div class="p-3 bg-white">
                <div class="table-responsive shadow-sm radius-10">
                    <table class="table table-card-table table-borderless table-hover bg-transparent m-0">
                        <thead>
                            <tr>
                                <th>ุงูุฅุณู</th>
                                <th>ุงูุนูุงุฏุฉ ุงูุทุจูุฉ</th>
                                <th>ุงูุฎุฏูุฉ ุงูุทุจูุฉ</th>
                                <th>ุฃุดุนุฉ ุงูุฌุณู</th>
                                <th>ุฑูู ุงูุญุฌุฒ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <ng-container>
                                <tr *ngFor="let appointment of patients" [ngClass]="{'canceled-row': appointment.status === 'ููุบู'}" (click)="openAppointmentModal(appointment.id)" data-bs-toggle="modal" data-bs-target="#bookingDetailsModal" style="cursor: pointer; background-color: red !important;">
                                    <td>
                                        <div class="d-flex align-items-center gap-2 justify-content-start">
                                            <div class="avatar-circle">{{ appointment.patientName.charAt(0) }}</div>
                                            <span class="fw-bold">{{ appointment.patientName }}</span>
                                        </div>
                                    </td>
                                    <td class="text-secondary fw-semibold">
                                        <app-tag [tags]="appointment.medicalServiceName" [header]="'ุงูุนูุงุฏุฉ ุงูุทุจูุฉ'" [showWithMore]="true"></app-tag>
                                    </td>
                                    <td>
                                        <p class="text-white status-pill fw-bold" *ngIf="appointment.type" [ngStyle]="{ backgroundColor: getServiceColor(appointment.type) }">
                                            {{ getServiceName(appointment.type) }}
                                        </p>
                                    </td>
                                    <td class="text-secondary fw-semibold">
                                        <app-tag [tags]="appointment.radiologyBodyTypeName" [header]="'ุฃุดุนุฉ ุงูุฌุณู'" [showWithMore]="true"></app-tag>
                                    </td>

                                    <td class="text-secondary">{{ appointment.id }}</td>
                            </ng-container>
                        </tbody>
                    </table>
                </div>
                <div class="align-items-center border-bottom d-flex flex-wrap justify-content-between p-3 table-card-title bg-light">
                    <div class="col-md-8 mb-2"></div>
                    <div class="col-md-4 mb-2" *ngIf="total > 0">
                        <app-pagination (pageChanged)="onPageChange($event)" [currentPage]="pagingFilterModel.currentPage" [pageSize]="pagingFilterModel.pageSize" [totalCount]="total"></app-pagination>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div class="modal fade" id="bookingDetailsModal" tabindex="-1" aria-labelledby="bookingDetailsLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <!-- <img src="assets/vendors/imgs/pattern.png" alt="" class="img-fluid"> -->
            <div class="modal-header justify-content-center">
                <h5 class="modal-title" id="bookingDetailsLabel">ุชูุงุตูู ุงูุญุฌุฒ</h5>
            </div>

            <div id="pdfContent" class="modal-body p-4 print-section">

                <div class="row mb-3">
                    <h4>
                        ๐ค ุชูุงุตูู ุงููุฑูุถ</h4>
                    <div class="col-lg-4">
                        <strong class="strong">ุงุณู ุงููุฑูุถ:</strong> <span class="span"> {{ selectedAppointment?.patientName || '---' }}</span>
                    </div>
                    <div class="col-lg-4">
                        <strong class="strong">ุงูุฑูู ุงูุทุจู:</strong> <span class="span"> {{ selectedAppointment?.patientId || '---' }}</span>
                    </div>
                    <div class="col-lg-4">
                        <strong class="strong">ุฑูู ุงูุญุฌุฒ:</strong> <span class="span"> {{ selectedAppointment?.id || '---' }}</span>
                    </div>
                    <div class="col-lg-4">
                        <strong class="strong">ุชุงุฑูุฎ ุงูุญุฌุฒ:</strong> <span class="span"> {{ selectedAppointment?.createdOn | date:'yyyy-MM-dd' }}</span>
                    </div>
                    <div class="col-lg-4">
                        <strong class="strong">ุงูููุช:</strong> <span class="span"> {{ selectedAppointment?.createdOn | date:'hh:mm a' }}</span>
                    </div>
                    <div class="col-lg-4">
                        <strong class="strong">ุงูุญุงูุฉ:</strong> <span class="span"> {{ selectedAppointment?.status }}</span>
                    </div>
                </div>
                <hr>

                <h4 class="mb-3">
                    ๐ ุชูุงุตูู ุงูุญุฌุฒ</h4>
                <div class="row mb-3">
                    <div class="col-lg-3" *ngIf="selectedAppointment?.type == 'Emergency'">
                        <strong class="strong">ููุน ุงูุญุฌุฒ:</strong> <span class="span"> {{ selectedAppointment?.type || '---' }}</span>
                    </div>
                    <div *ngIf="selectedAppointment?.type !== 'Emergency'" class="row">
                        <div class="col-lg-3">
                            <strong class="strong">ููุน ุงูุญุฌุฒ:</strong> <span class="span"> {{ selectedAppointment?.type || '---' }}</span>
                        </div>
                        <!-- <div class="col-lg-3">
                            <strong class="strong">ุงูุนูุงุฏุฉ:</strong> <span class="span"> {{ item.medicalServiceName || '---' }}</span>
                        </div> -->
                        <div class="col-lg-3">
                            <strong class="strong">ุงูุทุจูุจ:</strong> <span class="span"> {{ selectedAppointment?.doctorName || '---' }}</span>
                        </div>
                        <div class="col-lg-3">
                            <strong class="strong">ุทุฑููุฉ ุงูุญุฌุฒ:</strong> ุนุจุฑ ุงูุชุทุจูู
                        </div>
                        <div class="col-lg-12">
                            <div class="p-3 bg-white">
                                <div class="table-responsive shadow-sm radius-10">
                                    <table class="table table-card-table table-borderless table-hover bg-transparent m-0">
                                        <thead>
                                            <tr>
                                                <th>ุชุงุฑูุฎ ุงูุญุฌุฒ</th>
                                                <th>ููุน ุงูุฎุฏูุฉ</th>
                                                <th>ุงูุฏูุชูุฑ ุงููุฎุชุต</th>
                                                <th>ุงูุชูููุฉ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <ng-container>
                                                <tr *ngFor="let item of selectedAppointment?.medicalServices">
                                                    <td>{{ item.medicalServiceDate | date: 'dd/MM/yyyy' }}</td>
                                                    <td>{{ item.medicalServiceName }}</td>
                                                    <td *ngIf="item.medicalServiceType == 'General' || item.medicalServiceType == 'Surgery' || item.medicalServiceType == 'Consultation'">{{ item.doctorName }}</td>
                                                    <td *ngIf="item.medicalServiceType == 'Screening' || item.medicalServiceType == 'Radiology'">{{ '---' }}</td>
                                                    <td>{{ item.medicalServicePrice }} ุฌููู</td>
                                                </tr>
                                                <tr *ngIf="selectedAppointment?.medicalServices?.length">
                                                    <td></td>
                                                    <td class="text-end fw-bold">ุฅุฌูุงูู ุชูููุฉ ุงูุฎุฏูุฉ</td>
                                                    <td></td>
                                                    <td class="fw-bold">{{ totalPrice }} ุฌููู</td>
                                                </tr>
                                            </ng-container>
                                            <ng-container>
                                                <tr *ngIf="!selectedAppointment?.medicalServices?.length">
                                                    <td colspan="12" class="text-right">
                                                        <app-empty-data [showEmptyData]="!selectedAppointment?.medicalServices?.length"></app-empty-data>
                                                    </td>
                                                </tr>
                                            </ng-container>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="row mb-3" *ngIf="selectedAppointment?.type === 'Emergency'">
                    <h4 class="mb-3">
                        ๐ฅ ุจูุงูุงุช ุงููุฑุงูู</h4>
                    <div class="col-lg-4">
                        <strong class="strong">ุงุณู ุงููุฑุงูู:</strong> <span class="span"> {{ selectedAppointment?.companionName || '---' }}</span>
                    </div>
                    <div class="col-lg-4">
                        <strong class="strong">ุฑูู ุงููููุฉ:</strong> <span class="span"> {{ selectedAppointment?.companionNationalId || '---' }}</span>
                    </div>
                    <div class="col-lg-4">
                        <strong class="strong">ุฑูู ุงููุงุชู:</strong> <span class="span"> {{ selectedAppointment?.companionPhone || '---' }}</span>
                    </div>
                    <hr class="mt-3">
                </div>

                <h4 class="mb-3">
                    ๐ถ ุจูุงูุงุช ุงูุฏูุน</h4>
                <div class="row mb-3">
                    <div class="col-lg-4">
                        <strong class="strong">ุทุฑููุฉ ุงูุฏูุน:</strong> <span class="span"> {{ selectedAppointment?.paymentMethod || '---' }}</span>
                    </div>
                    <div class="col-lg-4">
                        <strong class="strong">ูููุฉ ุงููุดู:</strong> <span class="span"> {{ selectedAppointment?.medicalServicePrice || '---' }} ุฌููู</span>
                    </div>
                    <div class="col-lg-4">
                        <strong class="strong">ุชู ุงูุฏูุน:</strong> <span class="span"> {{ selectedAppointment?.isPaid ? 'ูุนู' : 'ูุง' }}</span>
                    </div>
                </div>

                <hr>

                <h4 class="mb-3">
                    ๐ ููุงุญุธุงุช ุฅุถุงููุฉ</h4>
                <p class="text-muted"> <span class="span"> {{ selectedAppointment?.notes || 'ูุง ููุฌุฏ ููุงุญุธุงุช' }}</span></p>

            </div>

            <div class="modal-footer row">
                <div class="col-2 m-0">
                    <button class="btn col-12 btn-outline-warning" data-bs-target="#updateEmergencyModal" data-bs-toggle="modal">ุชุญุฏูุซ ุงูุญุงูุฉ</button>
                </div>
                <div class="col-2 m-0">
                    <button class="btn col-12 btn-outline-success" routerLink="/hms/appointments/edit/{{selectedAppointment?.id}}">ุชุนุฏูู ุงูุญุฌุฒ</button>
                </div>
                <div class="col-2 m-0">
                    <button class="btn col-12 btn-outline-info" (click)="print()">ุทุจุงุนุฉ</button>
                </div>
                <div class="col-2 m-0">
                    <button class="btn col-12 btn-outline-primary" (click)="exportToPDF()">ุชุญููู ุฅูู PDF</button>
                </div>
                <div class="col-2 m-0">
                    <button class="btn col-12 btn-outline-warning">ุชุญููู ุฅูู ูุงุชูุฑุฉ</button>
                </div>
                <div class="col-2 m-0">
                    <button class="btn col-12 btn-outline-danger" (click)="deleteAppointment(selectedAppointment?.id)">ุญุฐู ุงูุญุฌุฒ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="updateEmergencyModal" tabindex="-1" role="dialog" aria-labelledby="updateEmergencyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <img src="assets/vendors/imgs/pattern.png" alt="" class="img-fluid">
            <div class="modal-header">
                <h5 class="modal-title" id="updateEmergencyModalLabel">ุชุญุฏูุซ ุงูุญุงูุฉ</h5>
            </div>
            <div class="modal-body">
                <form [formGroup]="updateEmergencyForm" (ngSubmit)="onSubmit()">
                    <div class="form-group mb-3">
                        <label class="form-label">ุงูุญุงูุฉ ุงูููุงุฆูุฉ</label>
                        <select class="form-select shadow-none" formControlName="newStatus">
                            <option selected disabled value="">ุงุฎุชุฑ ุงูุญุงูุฉ</option>
                            <option value="CriticalCondition">ุชู ูููู ุฅูู ุงูุนูุงูุฉ ุงููุฑูุฒุฉ</option>
                            <option value="Surgery">ุฏุฎู ุบุฑูุฉ ุงูุนูููุงุช</option>
                            <!-- <option value="General">ุชู ุชุญูููู ุฅูู ูุดู</option> -->
                            <option value="Treated">ุชู ุนูุงุฌู</option>
                            <option value="Archived">ุชู ูููู ุฅูู ูุณุชุดูู ุฃุฎุฑู</option>
                            <option value="Archived">ุฑูุถ ุงูุนูุงุฌ ูุฎุฑุฌ ุนูู ูุณุคูููุชู</option>
                            <option value="Archived">ุชููู</option>
                        </select>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">ููุงุญุธุงุช</label>
                        <textarea class="form-control shadow-none" formControlName="notes"></textarea>
                    </div>

                    <button type="submit" [disabled]="updateEmergencyForm.invalid" class="btn-blue">ุญูุธ ุงูุชุญุฏูุซ</button>
                </form>
            </div>
        </div>
    </div>
</div>




<div class="modal fade" id="cashMovementModal" tabindex="-1" aria-labelledby="cashMovementLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cashMovementLabel">ูุดู ุญุฑูุฉ ุงูุฎุฒููุฉ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ุฅุบูุงู"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered text-center">
                    <thead class="table-light">
                        <tr>
                            <th>ุงูููู</th>
                            <th>ุงูุนุฏุฏ</th>
                            <th>ุงูุณุนุฑ ุงูุฅุฌูุงูู</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of cashMovementData">
                            <td>{{ item.day }}</td>
                            <td>{{ item.count }}</td>
                            <td>{{ item.total | currency:'EGP' }}</td>
                        </tr>
                        <tr class="fw-bold table-secondary">
                            <td>ุงูุนูุงุฏุงุช</td>
                            <td>{{ clinicCount }}</td>
                            <td>{{ clinicTotal | currency:'EGP' }}</td>
                        </tr>
                        <tr class="fw-bold table-dark text-white">
                            <td>ุงูุฅุฌูุงูู</td>
                            <td>{{ totalCount }}</td>
                            <td>{{ totalAmount | currency:'EGP' }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>



<div id="printablePDFContent" style=" display: none;" dir="rtl" class="container border rounded p-5">
    <div class="d-flex justify-content-around align-items-center mb-2">
        <img src="assets/vendors/imgs/logo.png" alt="logo" style="height: 100px;" />
        <div class="text-center">
            <h5 class="fw-bold mb-1">  ุญุฌุฒ ุฑูู    <span class="text-primary">  {{ selectedAppointment?.id }}</span></h5>
        </div>
    </div>
  
    <h5 class="fw-bold mb-2">ุจูุงูุงุช ุงููุฑูุถ</h5>
    <div class="row">
        <div class="col-lg-6">
            <p><strong>ุงูุงุณู:</strong> {{ selectedAppointment?.patientName || '---' }}</p>
            <p><strong>ุงูุฑูู ุงูุทุจู:</strong> {{ selectedAppointment?.patientId || '---' }}</p>
            <p><strong>ุฑูู ุงููุงุชู:</strong> {{ selectedAppointment?.patientPhone || '---' }}</p>
        </div>
        <div class="col-lg-6">
            <p><strong>ุงูุชุงุฑูุฎ:</strong> {{ selectedAppointment?.createdOn | date:'yyyy-MM-dd' }}</p>
            <p><strong>ุงูููุช:</strong> {{ selectedAppointment?.createdOn | date:'hh:mm a' }}</p>
            <p><strong>ุงูุญุงูุฉ:</strong> {{ selectedAppointment?.status || '---' }}</p>
        </div>
    </div>
  
    <hr>
  
    <h5 class="fw-bold mb-2">ุชูุงุตูู ุงูุญุฌุฒ</h5>
    <div class="row">
        <div class="col-lg-6">
            <p><strong>ููุน ุงูุญุฌุฒ:</strong> {{ selectedAppointment?.type || '---' }}</p>
            <p><strong>ุงูุทุจูุจ:</strong> {{ selectedAppointment?.doctorName || '---' }}</p>
        </div>
        <div class="col-lg-6">
            <p><strong>ุทุฑููุฉ ุงูุญุฌุฒ:</strong> ุนุจุฑ ุงูุชุทุจูู</p>
        </div>
    </div>
  
    <div *ngIf="selectedAppointment?.medicalServices?.length">
      <table class="border rounded">
        <thead>
          <tr>
            <th>ุชุงุฑูุฎ ุงูุฎุฏูุฉ</th>
            <th>ููุน ุงูุฎุฏูุฉ</th>
            <th>ุงูุฏูุชูุฑ</th>
            <th>ุงูุณุนุฑ</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of selectedAppointment?.medicalServices">
            <td>{{ item.medicalServiceDate | date:'dd/MM/yyyy' }}</td>
            <td>{{ item.medicalServiceName }}</td>
            <td *ngIf="item.medicalServiceType == 'General' || item.medicalServiceType == 'Surgery' || item.medicalServiceType == 'Consultation'">{{ item.doctorName }}</td>
            <td *ngIf="item.medicalServiceType == 'Screening' || item.medicalServiceType == 'Radiology'">---</td>
            <td>{{ item.medicalServicePrice }} ุฌููู</td>
          </tr>
          <tr>
            <td colspan="3" class="fw-bold text-center">ุงูุฅุฌูุงูู</td>
            <td class="fw-bold">{{ totalPrice }} ุฌููู</td>
          </tr>
        </tbody>
      </table>
    </div>
  
  
    <div *ngIf="selectedAppointment?.type === 'Emergency'">
      <h5 class="fw-bold mb-2">ุจูุงูุงุช ุงููุฑุงูู</h5>
      <div class="row">
        <div class="col-lg-6">
            <p><strong>ุงูุงุณู:</strong> {{ selectedAppointment?.companionName || '---' }}</p>
            <p><strong>ุงููููุฉ:</strong> {{ selectedAppointment?.companionNationalId || '---' }}</p>
        </div>
        <div class="col-lg-6">
            <p><strong>ุฑูู ุงููุงุชู:</strong> {{ selectedAppointment?.companionPhone || '---' }}</p>
        </div>
      </div>
    </div>
    <div *ngIf="selectedAppointment?.notes">
        <hr>
        <h5 class="fw-bold mb-2">๐ ููุงุญุธุงุช ุฅุถุงููุฉ</h5>
        <p>{{ selectedAppointment?.notes || '---' }}</p>
    </div>
    
    <div class="row mt-4">
        <hr>
        <div class="col-md-6">
          <strong>ุฅุณู ุงููุณุชุฎุฏู:</strong> {{ userName }}
        </div>
        <div class="col-md-6 text-end">
          <strong>ุงูุชุงุฑูุฎ:</strong> {{ today }}
        </div>
      </div>
  </div>
  